{% extends "base.html" %}

{% block head %}
<style>
  .search-container { max-width: 1200px; margin: 0 auto; }
  .search-header { margin-bottom: 2.5rem; text-align: center; }
  .search-header h1 { font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.75rem; }
  .search-header p { color: var(--text-secondary); font-size: 0.95rem; margin: 0; }

  /* Form Styles */
  .search-form-card { background-color: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); margin-bottom: 2rem; }
  .search-form-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
  .form-icon { width: 32px; height: 32px; background-color: rgba(14, 165, 233, 0.1); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  
  .rows-container { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 1.5rem; }
  .query-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; padding: 1.5rem; background-color: var(--background); border: 1px solid var(--border); border-radius: 8px; align-items: flex-end; position: relative; }
  .query-row-number { position: absolute; top: -12px; left: 12px; background-color: var(--primary-accent); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
  
  .form-group { display: flex; flex-direction: column; }
  .form-label { font-weight: 500; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; }
  .label-required { color: var(--danger); font-weight: 700; }
  .label-optional { color: var(--text-light); font-size: 0.75rem; font-weight: 400; }
  .form-control { border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem; font-size: 0.95rem; background-color: var(--surface); color: var(--text-primary); transition: all 0.2s ease; }
  .form-control:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); outline: none; }
  .form-text { margin-top: 0.35rem; font-size: 0.75rem; color: var(--text-light); }
  
  .row-actions { display: flex; gap: 0.5rem; }
  .btn-remove { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s ease; }
  .btn-remove:hover { background-color: var(--danger); color: white; }
  .btn-add-row { background-color: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px dashed #22c55e; padding: 1rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.2s ease; text-align: center; display: block; width: 100%; }
  .btn-add-row:hover { background-color: #22c55e; color: white; }
  .info-box { background-color: rgba(14, 165, 233, 0.05); border-left: 4px solid var(--primary-accent); border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; color: var(--text-primary); font-size: 0.9rem; }
  .form-actions { display: flex; gap: 1rem; justify-content: center; }
  .form-actions .btn { min-width: 150px; }

  /* Loading state below form */
  .loading-state { 
    display: none; 
    align-items: center; 
    justify-content: center; 
    gap: 1rem; 
    padding: 1.5rem; 
    margin-top: 1rem;
    background-color: rgba(14, 165, 233, 0.05); 
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.95rem;
  }
  .loading-state.show { display: flex; }
  .loading-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(14, 165, 233, 0.2);
    border-top-color: var(--primary-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Results with horizontal card layout */
  .results-container { margin-top: 2rem; }
  .results-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border); }
  
  /* Horizontal scrollable cards */
  .name-cards-container {
    overflow-x: auto;
    white-space: nowrap;
    padding: 1rem 0;
    margin-bottom: 2rem;
    display: flex;
    gap: 1rem;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-accent) var(--background);
  }
  .name-cards-container::-webkit-scrollbar {
    height: 8px;
  }
  .name-cards-container::-webkit-scrollbar-track {
    background: var(--background);
    border-radius: 4px;
  }
  .name-cards-container::-webkit-scrollbar-thumb {
    background: var(--primary-accent);
    border-radius: 4px;
  }
  
  .name-card {
    min-width: 280px;
    flex-shrink: 0;
    background-color: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: normal;
  }
  .name-card:hover {
    border-color: var(--primary-accent);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
    transform: translateY(-2px);
  }
  .name-card.active {
    border-color: var(--primary-accent);
    background-color: rgba(14, 165, 233, 0.05);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
  }
  .name-card-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    -webkit-line-clamp: 2;
    line-clamp: 2; 
  }
  .name-card-matches {
    display: inline-block;
    background-color: rgba(14, 165, 233, 0.1);
    color: var(--primary-accent);
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  /* Table with simplified scores */
  .results-table-container {
    background-color: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-top: 1rem;
  }
  .results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  .results-table th { padding: 1.25rem; text-align: left; font-weight: 600; color: var(--text-primary); white-space: nowrap; background-color: var(--background); border-bottom: 2px solid var(--border); }
  .results-table td { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); color: var(--text-primary); vertical-align: top; }
  .results-table tbody tr:hover { background-color: rgba(14, 165, 233, 0.03); }
  .results-table tbody tr:last-child td { border-bottom: none; }

  .entity-name { font-weight: 500; color: var(--text-primary); display: block; }
  .entity-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }
  
  .score-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem; font-family: 'Courier New', monospace; }
  .score-high { background-color: rgba(239, 68, 68, 0.1); color: var(--danger); }
  .score-medium { background-color: rgba(245, 158, 11, 0.1); color: var(--warning); }
  .score-low { background-color: rgba(14, 165, 233, 0.1); color: var(--primary-accent); }

  /* Score breakdown collapsible */
  .score-cell {
    position: relative;
  }
  .score-breakdown-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-top: 0.5rem;
    color: var(--text-light);
    font-size: 0.8rem;
    transition: color 0.2s ease;
  }
  .score-breakdown-btn:hover {
    color: var(--text-primary);
  }
  .score-breakdown-btn .arrow-icon {
    display: inline-block;
    transition: transform 0.3s ease;
    font-size: 0.7rem;
  }
  .score-breakdown-btn.expanded .arrow-icon {
    transform: rotate(180deg);
  }
  
  .score-breakdown-section {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, margin 0.3s ease;
  }
  .score-breakdown-section.expanded {
    max-height: 300px;
    margin-top: 0.75rem;
  }
  .score-breakdown-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem;
    background-color: rgba(14, 165, 233, 0.03);
    border-radius: 6px;
    font-size: 0.85rem;
  }
  .score-breakdown-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.35rem 0;
  }
  .score-breakdown-label {
    color: var(--text-secondary);
    font-weight: 500;
  }
  .score-breakdown-value {
    font-family: 'Courier New', monospace;
    font-weight: 600;
    color: var(--text-primary);
  }
  
  .geo-collapsible-btn { 
    display: flex; 
    align-items: center; 
    gap: 0.5rem; 
    cursor: pointer; 
    color: var(--primary-accent); 
    font-size: 0.85rem; 
    font-weight: 500; 
    background: none; 
    border: none; 
    padding: 0.5rem 0; 
    margin-top: 0.5rem;
    transition: all 0.2s ease;
  }
  .geo-collapsible-btn:hover { color: var(--text-primary); }
  .geo-collapsible-btn .arrow-icon { 
    display: inline-block; 
    transition: transform 0.3s ease; 
  }
  .geo-collapsible-btn.expanded .arrow-icon { 
    transform: rotate(180deg); 
  }

  .geo-profiling-section { 
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.3s ease, padding 0.3s ease; 
    background-color: rgba(14, 165, 233, 0.03); 
    border-bottom: 1px solid var(--border);
  }
  .geo-profiling-section.expanded { 
    max-height: 500px; 
    padding: 1.25rem; 
  }

  .geo-profiling-content { 
    display: flex; 
    flex-direction: column; 
    gap: 0.75rem; 
  }

  .geo-item { 
    display: flex; 
    align-items: flex-start; 
    gap: 0.75rem; 
    padding: 0.75rem; 
    background-color: var(--surface); 
    border-radius: 6px; 
    border-left: 3px solid var(--primary-accent);
  }
  .geo-item-icon { 
    font-size: 1rem; 
    flex-shrink: 0; 
    margin-top: 2px;
  }
  .geo-item-content { 
    display: flex; 
    flex-direction: column; 
    gap: 0.25rem; 
  }
  .geo-item-label { 
    font-weight: 500; 
    color: var(--text-primary); 
    font-size: 0.9rem; 
  }
  .geo-item-value { 
    color: var(--text-secondary); 
    font-size: 0.85rem; 
  }

  .geo-insights-box { 
    background-color: #fef3c7; 
    border: 1px solid #fcd34d; 
    border-radius: 6px; 
    padding: 0.75rem; 
    color: #92400e; 
    font-size: 0.85rem;
  }
  .geo-insights-box strong { 
    display: block; 
    font-weight: 600; 
    margin-bottom: 0.5rem; 
  }
  .geo-insights-list { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
  }
  .geo-insights-list li { 
    padding: 0.35rem 0; 
  }
  .geo-insights-list li:before { 
    content: '‚ö†Ô∏è '; 
    margin-right: 0.5rem; 
  }

  /* Responsive */
  @media (max-width: 768px) {
    .query-row { grid-template-columns: 1fr; padding-top: 2rem; }
    .query-row-number { top: -6px; }
    .row-actions { grid-column: 1 / -1; }
    .results-table th, .results-table td { padding: 0.75rem 0.5rem; font-size: 0.8rem; }
    .geo-profiling-section.expanded { max-height: 600px; }
    .name-card { min-width: 220px; }
  }

  /* Adding searchable select dropdown styles */
  .searchable-select-wrapper {
    position: relative;
  }
  
  .searchable-select-input {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.95rem;
    background-color: var(--surface);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .searchable-select-input:focus {
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    outline: none;
    cursor: text;
  }
  
  .searchable-select-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background-color: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
  }
  
  .searchable-select-dropdown.show {
    display: block;
  }
  
  .searchable-select-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background-color 0.15s ease;
    color: var(--text-primary);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .searchable-select-option:hover {
    background-color: rgba(14, 165, 233, 0.08);
  }
  
  .searchable-select-option.selected {
    background-color: rgba(14, 165, 233, 0.12);
    font-weight: 500;
  }
  
  .searchable-select-option .country-flag {
    font-size: 1.1rem;
  }
  
  .searchable-select-option .country-info {
    display: flex;
    flex-direction: column;
  }
  
  .searchable-select-option .country-name {
    font-weight: 500;
  }
  
  .searchable-select-option .country-code {
    font-size: 0.75rem;
    color: var(--text-light);
  }
  
  .searchable-select-empty {
    padding: 1rem;
    text-align: center;
    color: var(--text-light);
    font-size: 0.85rem;
  }
  
  .select-clear-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.1rem;
    display: none;
    transition: color 0.2s ease;
  }
  
  .select-clear-btn:hover {
    color: var(--danger);
  }
  
  .select-clear-btn.show {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
  <div class="search-header">
    <h1>Screening Cepat Nasabah</h1>
    <p>Lakukan screening instan untuk satu atau lebih nasabah</p>
  </div>

  <div class="search-form-card">
    <div class="search-form-title">
      <div class="form-icon">üîç</div>
      Masukkan Data Nasabah
    </div>
    <div class="info-box">
      <strong>Cara Menggunakan:</strong>
      Tambahkan baris untuk setiap nasabah yang ingin dicek. Klik "Lakukan Screening" untuk memproses semua sekaligus.
    </div>

    <form id="bulkSearchForm">
      <div class="rows-container" id="rowsContainer"></div>
      <button type="button" class="btn-add-row" onclick="addQueryRow()">+ Tambah Nasabah</button>
      <div class="form-actions" style="margin-top: 2rem;">
        <a href="{{ url_for('web.index') }}" class="btn btn-outline-primary">Kembali</a>
        <button type="submit" class="btn btn-primary" id="submitBtn">Lakukan Screening ‚Üí</button>
      </div>
      <!-- Loading state below form instead of button -->
      <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <span>Screening sedang dilakukan, harap tunggu...</span>
      </div>
    </form>
  </div>

  <!-- Results container with horizontal cards -->
  <div id="resultsContainer" style="display: none;">
    <div class="results-container">
      <div class="results-header">
        <h2>Hasil Pencarian</h2>
        <div class="results-info" id="resultsInfo"></div>
      </div>
      <!-- Horizontal scrollable cards for name selection -->
      <div class="name-cards-container" id="nameCardsContainer"></div>
      <!-- Table for selected name's matches -->
      <div id="resultsTableContainer"></div>
    </div>
  </div>
</div>

<template id="queryRowTemplate">
  <div class="query-row">
    <div class="query-row-number">-</div>
    <div class="form-group">
      <label class="form-label" for="query-name">Nama Nasabah <span class="label-required">*</span></label>
      <input type="text" id="query-name" class="form-control query-name" placeholder="Contoh: Budi Santoso" required>
    </div>
    <div class="form-group">
      <label class="form-label" for="query-dob">Tanggal Lahir <span class="label-optional">(Opsional)</span></label>
      <input type="date" id="query-dob" class="form-control query-dob">
    </div>
    <div class="form-group">
      <label class="form-label" for="query-citizenship">Kewarganegaraan <span class="label-optional">(Opsional)</span></label>
      <div class="searchable-select-wrapper">
        <input
          type="text"
          id="query-citizenship"
          class="searchable-select-input query-citizenship"
          placeholder="Ketik atau pilih negara..."
          autocomplete="off"
        >
        <button type="button" class="select-clear-btn" onclick="clearSelection(this)">√ó</button>
        <div class="searchable-select-dropdown"></div>
      </div>
    </div>
    <div class="row-actions">
      <button type="button" class="btn-remove" onclick="removeQueryRow(this)">Hapus</button>
    </div>
  </div>
</template>

<script>
  const COUNTRIES = [
    { code: 'AF', code3: 'AFG', nameEn: 'Afghanistan', nameId: 'Afganistan', flag: 'üá¶üá´' },
    { code: 'AL', code3: 'ALB', nameEn: 'Albania', nameId: 'Albania', flag: 'üá¶üá±' },
    { code: 'DZ', code3: 'DZA', nameEn: 'Algeria', nameId: 'Aljazair', flag: 'üá©üáø' },
    { code: 'AD', code3: 'AND', nameEn: 'Andorra', nameId: 'Andorra', flag: 'üá¶üá©' },
    { code: 'AO', code3: 'AGO', nameEn: 'Angola', nameId: 'Angola', flag: 'üá¶üá¥' },
    { code: 'AG', code3: 'ATG', nameEn: 'Antigua and Barbuda', nameId: 'Antigua dan Barbuda', flag: 'üá¶üá¨' },
    { code: 'AR', code3: 'ARG', nameEn: 'Argentina', nameId: 'Argentina', flag: 'üá¶üá∑' },
    { code: 'AM', code3: 'ARM', nameEn: 'Armenia', nameId: 'Armenia', flag: 'üá¶üá≤' },
    { code: 'AU', code3: 'AUS', nameEn: 'Australia', nameId: 'Australia', flag: 'üá¶üá∫' },
    { code: 'AT', code3: 'AUT', nameEn: 'Austria', nameId: 'Austria', flag: 'üá¶üáπ' },
    { code: 'AZ', code3: 'AZE', nameEn: 'Azerbaijan', nameId: 'Azerbaijan', flag: 'üá¶üáø' },

    { code: 'BS', code3: 'BHS', nameEn: 'Bahamas', nameId: 'Bahama', flag: 'üáßüá∏' },
    { code: 'BH', code3: 'BHR', nameEn: 'Bahrain', nameId: 'Bahrain', flag: 'üáßüá≠' },
    { code: 'BD', code3: 'BGD', nameEn: 'Bangladesh', nameId: 'Bangladesh', flag: 'üáßüá©' },
    { code: 'BB', code3: 'BRB', nameEn: 'Barbados', nameId: 'Barbados', flag: 'üáßüáß' },
    { code: 'BY', code3: 'BLR', nameEn: 'Belarus', nameId: 'Belarus', flag: 'üáßüáæ' },
    { code: 'BE', code3: 'BEL', nameEn: 'Belgium', nameId: 'Belgia', flag: 'üáßüá™' },
    { code: 'BZ', code3: 'BLZ', nameEn: 'Belize', nameId: 'Belize', flag: 'üáßüáø' },
    { code: 'BJ', code3: 'BEN', nameEn: 'Benin', nameId: 'Benin', flag: 'üáßüáØ' },
    { code: 'BT', code3: 'BTN', nameEn: 'Bhutan', nameId: 'Bhutan', flag: 'üáßüáπ' },
    { code: 'BO', code3: 'BOL', nameEn: 'Bolivia', nameId: 'Bolivia', flag: 'üáßüá¥' },
    { code: 'BA', code3: 'BIH', nameEn: 'Bosnia and Herzegovina', nameId: 'Bosnia dan Herzegovina', flag: 'üáßüá¶' },
    { code: 'BW', code3: 'BWA', nameEn: 'Botswana', nameId: 'Botswana', flag: 'üáßüáº' },
    { code: 'BR', code3: 'BRA', nameEn: 'Brazil', nameId: 'Brasil', flag: 'üáßüá∑' },
    { code: 'BN', code3: 'BRN', nameEn: 'Brunei', nameId: 'Brunei', flag: 'üáßüá≥' },
    { code: 'BG', code3: 'BGR', nameEn: 'Bulgaria', nameId: 'Bulgaria', flag: 'üáßüá¨' },
    { code: 'BF', code3: 'BFA', nameEn: 'Burkina Faso', nameId: 'Burkina Faso', flag: 'üáßüá´' },
    { code: 'BI', code3: 'BDI', nameEn: 'Burundi', nameId: 'Burundi', flag: 'üáßüáÆ' },

    { code: 'CV', code3: 'CPV', nameEn: 'Cabo Verde', nameId: 'Tanjung Verde', flag: 'üá®üáª' },
    { code: 'KH', code3: 'KHM', nameEn: 'Cambodia', nameId: 'Kamboja', flag: 'üá∞üá≠' },
    { code: 'CM', code3: 'CMR', nameEn: 'Cameroon', nameId: 'Kamerun', flag: 'üá®üá≤' },
    { code: 'CA', code3: 'CAN', nameEn: 'Canada', nameId: 'Kanada', flag: 'üá®üá¶' },
    { code: 'CF', code3: 'CAF', nameEn: 'Central African Republic', nameId: 'Republik Afrika Tengah', flag: 'üá®üá´' },
    { code: 'TD', code3: 'TCD', nameEn: 'Chad', nameId: 'Chad', flag: 'üáπüá©' },
    { code: 'CL', code3: 'CHL', nameEn: 'Chile', nameId: 'Chili', flag: 'üá®üá±' },
    { code: 'CN', code3: 'CHN', nameEn: 'China', nameId: 'Tiongkok', flag: 'üá®üá≥' },
    { code: 'CO', code3: 'COL', nameEn: 'Colombia', nameId: 'Kolombia', flag: 'üá®üá¥' },
    { code: 'KM', code3: 'COM', nameEn: 'Comoros', nameId: 'Komoro', flag: 'üá∞üá≤' },
    { code: 'CD', code3: 'COD', nameEn: 'Congo (Democratic Republic)', nameId: 'Kongo (Republik Demokratik)', flag: 'üá®üá©' },
    { code: 'CG', code3: 'COG', nameEn: 'Congo (Republic)', nameId: 'Kongo (Republik)', flag: 'üá®üá¨' },
    { code: 'CR', code3: 'CRI', nameEn: 'Costa Rica', nameId: 'Kosta Rika', flag: 'üá®üá∑' },
    { code: 'CI', code3: 'CIV', nameEn: 'Cote d\'Ivoire', nameId: 'Pantai Gading', flag: 'üá®üáÆ' },
    { code: 'HR', code3: 'HRV', nameEn: 'Croatia', nameId: 'Kroasia', flag: 'üá≠üá∑' },
    { code: 'CU', code3: 'CUB', nameEn: 'Cuba', nameId: 'Kuba', flag: 'üá®üá∫' },
    { code: 'CY', code3: 'CYP', nameEn: 'Cyprus', nameId: 'Siprus', flag: 'üá®üáæ' },
    { code: 'CZ', code3: 'CZE', nameEn: 'Czech Republic', nameId: 'Republik Ceko', flag: 'üá®üáø' },

    { code: 'DK', code3: 'DNK', nameEn: 'Denmark', nameId: 'Denmark', flag: 'üá©üá∞' },
    { code: 'DJ', code3: 'DJI', nameEn: 'Djibouti', nameId: 'Djibouti', flag: 'üá©üáØ' },
    { code: 'DM', code3: 'DMA', nameEn: 'Dominica', nameId: 'Dominika', flag: 'üá©üá≤' },
    { code: 'DO', code3: 'DOM', nameEn: 'Dominican Republic', nameId: 'Republik Dominika', flag: 'üá©üá¥' },

    { code: 'EC', code3: 'ECU', nameEn: 'Ecuador', nameId: 'Ekuador', flag: 'üá™üá®' },
    { code: 'EG', code3: 'EGY', nameEn: 'Egypt', nameId: 'Mesir', flag: 'üá™üá¨' },
    { code: 'SV', code3: 'SLV', nameEn: 'El Salvador', nameId: 'El Salvador', flag: 'üá∏üáª' },
    { code: 'GQ', code3: 'GNQ', nameEn: 'Equatorial Guinea', nameId: 'Guinea Khatulistiwa', flag: 'üá¨üá∂' },
    { code: 'ER', code3: 'ERI', nameEn: 'Eritrea', nameId: 'Eritrea', flag: 'üá™üá∑' },
    { code: 'EE', code3: 'EST', nameEn: 'Estonia', nameId: 'Estonia', flag: 'üá™üá™' },
    { code: 'SZ', code3: 'SWZ', nameEn: 'Eswatini', nameId: 'Eswatini', flag: 'üá∏üáø' },
    { code: 'ET', code3: 'ETH', nameEn: 'Ethiopia', nameId: 'Ethiopia', flag: 'üá™üáπ' },

    { code: 'FJ', code3: 'FJI', nameEn: 'Fiji', nameId: 'Fiji', flag: 'üá´üáØ' },
    { code: 'FI', code3: 'FIN', nameEn: 'Finland', nameId: 'Finlandia', flag: 'üá´üáÆ' },
    { code: 'FR', code3: 'FRA', nameEn: 'France', nameId: 'Prancis', flag: 'üá´üá∑' },

    { code: 'GA', code3: 'GAB', nameEn: 'Gabon', nameId: 'Gabon', flag: 'üá¨üá¶' },
    { code: 'GM', code3: 'GMB', nameEn: 'Gambia', nameId: 'Gambia', flag: 'üá¨üá≤' },
    { code: 'GE', code3: 'GEO', nameEn: 'Georgia', nameId: 'Georgia', flag: 'üá¨üá™' },
    { code: 'DE', code3: 'DEU', nameEn: 'Germany', nameId: 'Jerman', flag: 'üá©üá™' },
    { code: 'GH', code3: 'GHA', nameEn: 'Ghana', nameId: 'Ghana', flag: 'üá¨üá≠' },
    { code: 'GR', code3: 'GRC', nameEn: 'Greece', nameId: 'Yunani', flag: 'üá¨üá∑' },
    { code: 'GD', code3: 'GRD', nameEn: 'Grenada', nameId: 'Grenada', flag: 'üá¨üá©' },
    { code: 'GT', code3: 'GTM', nameEn: 'Guatemala', nameId: 'Guatemala', flag: 'üá¨üáπ' },
    { code: 'GN', code3: 'GIN', nameEn: 'Guinea', nameId: 'Guinea', flag: 'üá¨üá≥' },
    { code: 'GW', code3: 'GNB', nameEn: 'Guinea-Bissau', nameId: 'Guinea-Bissau', flag: 'üá¨üáº' },
    { code: 'GY', code3: 'GUY', nameEn: 'Guyana', nameId: 'Guyana', flag: 'üá¨üáæ' },

    { code: 'HT', code3: 'HTI', nameEn: 'Haiti', nameId: 'Haiti', flag: 'üá≠üáπ' },
    { code: 'HN', code3: 'HND', nameEn: 'Honduras', nameId: 'Honduras', flag: 'üá≠üá≥' },
    { code: 'HU', code3: 'HUN', nameEn: 'Hungary', nameId: 'Hungaria', flag: 'üá≠üá∫' },

    { code: 'IS', code3: 'ISL', nameEn: 'Iceland', nameId: 'Islandia', flag: 'üáÆüá∏' },
    { code: 'IN', code3: 'IND', nameEn: 'India', nameId: 'India', flag: 'üáÆüá≥' },
    { code: 'ID', code3: 'IDN', nameEn: 'Indonesia', nameId: 'Indonesia', flag: 'üáÆüá©' },
    { code: 'IR', code3: 'IRN', nameEn: 'Iran', nameId: 'Iran', flag: 'üáÆüá∑' },
    { code: 'IQ', code3: 'IRQ', nameEn: 'Iraq', nameId: 'Irak', flag: 'üáÆüá∂' },
    { code: 'IE', code3: 'IRL', nameEn: 'Ireland', nameId: 'Irlandia', flag: 'üáÆüá™' },
    { code: 'IL', code3: 'ISR', nameEn: 'Israel', nameId: 'Israel', flag: 'üáÆüá±' },
    { code: 'IT', code3: 'ITA', nameEn: 'Italy', nameId: 'Italia', flag: 'üáÆüáπ' },

    { code: 'JM', code3: 'JAM', nameEn: 'Jamaica', nameId: 'Jamaika', flag: 'üáØüá≤' },
    { code: 'JP', code3: 'JPN', nameEn: 'Japan', nameId: 'Jepang', flag: 'üáØüáµ' },
    { code: 'JO', code3: 'JOR', nameEn: 'Jordan', nameId: 'Yordania', flag: 'üáØüá¥' },

    { code: 'KZ', code3: 'KAZ', nameEn: 'Kazakhstan', nameId: 'Kazakhstan', flag: 'üá∞üáø' },
    { code: 'KE', code3: 'KEN', nameEn: 'Kenya', nameId: 'Kenya', flag: 'üá∞üá™' },
    { code: 'KI', code3: 'KIR', nameEn: 'Kiribati', nameId: 'Kiribati', flag: 'üá∞üáÆ' },
    { code: 'KW', code3: 'KWT', nameEn: 'Kuwait', nameId: 'Kuwait', flag: 'üá∞üáº' },
    { code: 'KG', code3: 'KGZ', nameEn: 'Kyrgyzstan', nameId: 'Kirgizstan', flag: 'üá∞üá¨' },

    { code: 'LA', code3: 'LAO', nameEn: 'Laos', nameId: 'Laos', flag: 'üá±üá¶' },
    { code: 'LV', code3: 'LVA', nameEn: 'Latvia', nameId: 'Latvia', flag: 'üá±üáª' },
    { code: 'LB', code3: 'LBN', nameEn: 'Lebanon', nameId: 'Lebanon', flag: 'üá±üáß' },
    { code: 'LS', code3: 'LSO', nameEn: 'Lesotho', nameId: 'Lesotho', flag: 'üá±üá∏' },
    { code: 'LR', code3: 'LBR', nameEn: 'Liberia', nameId: 'Liberia', flag: 'üá±üá∑' },
    { code: 'LY', code3: 'LBY', nameEn: 'Libya', nameId: 'Libya', flag: 'üá±üáæ' },
    { code: 'LI', code3: 'LIE', nameEn: 'Liechtenstein', nameId: 'Liechtenstein', flag: 'üá±üáÆ' },
    { code: 'LT', code3: 'LTU', nameEn: 'Lithuania', nameId: 'Lithuania', flag: 'üá±üáπ' },
    { code: 'LU', code3: 'LUX', nameEn: 'Luxembourg', nameId: 'Luksemburg', flag: 'üá±üá∫' },

    { code: 'MG', code3: 'MDG', nameEn: 'Madagascar', nameId: 'Madagaskar', flag: 'üá≤üá¨' },
    { code: 'MW', code3: 'MWI', nameEn: 'Malawi', nameId: 'Malawi', flag: 'üá≤üáº' },
    { code: 'MY', code3: 'MYS', nameEn: 'Malaysia', nameId: 'Malaysia', flag: 'üá≤üáæ' },
    { code: 'MV', code3: 'MDV', nameEn: 'Maldives', nameId: 'Maladewa', flag: 'üá≤üáª' },
    { code: 'ML', code3: 'MLI', nameEn: 'Mali', nameId: 'Mali', flag: 'üá≤üá±' },
    { code: 'MT', code3: 'MLT', nameEn: 'Malta', nameId: 'Malta', flag: 'üá≤üáπ' },
    { code: 'MH', code3: 'MHL', nameEn: 'Marshall Islands', nameId: 'Kepulauan Marshall', flag: 'üá≤üá≠' },
    { code: 'MR', code3: 'MRT', nameEn: 'Mauritania', nameId: 'Mauritania', flag: 'üá≤üá∑' },
    { code: 'MU', code3: 'MUS', nameEn: 'Mauritius', nameId: 'Mauritius', flag: 'üá≤üá∫' },
    { code: 'MX', code3: 'MEX', nameEn: 'Mexico', nameId: 'Meksiko', flag: 'üá≤üáΩ' },
    { code: 'FM', code3: 'FSM', nameEn: 'Micronesia', nameId: 'Mikronesia', flag: 'üá´üá≤' },
    { code: 'MD', code3: 'MDA', nameEn: 'Moldova', nameId: 'Moldova', flag: 'üá≤üá©' },
    { code: 'MC', code3: 'MCO', nameEn: 'Monaco', nameId: 'Monako', flag: 'üá≤üá®' },
    { code: 'MN', code3: 'MNG', nameEn: 'Mongolia', nameId: 'Mongolia', flag: 'üá≤üá≥' },
    { code: 'ME', code3: 'MNE', nameEn: 'Montenegro', nameId: 'Montenegro', flag: 'üá≤üá™' },
    { code: 'MA', code3: 'MAR', nameEn: 'Morocco', nameId: 'Maroko', flag: 'üá≤üá¶' },
    { code: 'MZ', code3: 'MOZ', nameEn: 'Mozambique', nameId: 'Mozambik', flag: 'üá≤üáø' },
    { code: 'MM', code3: 'MMR', nameEn: 'Myanmar', nameId: 'Myanmar', flag: 'üá≤üá≤' },

    { code: 'NA', code3: 'NAM', nameEn: 'Namibia', nameId: 'Namibia', flag: 'üá≥üá¶' },
    { code: 'NR', code3: 'NRU', nameEn: 'Nauru', nameId: 'Nauru', flag: 'üá≥üá∑' },
    { code: 'NP', code3: 'NPL', nameEn: 'Nepal', nameId: 'Nepal', flag: 'üá≥üáµ' },
    { code: 'NL', code3: 'NLD', nameEn: 'Netherlands', nameId: 'Belanda', flag: 'üá≥üá±' },
    { code: 'NZ', code3: 'NZL', nameEn: 'New Zealand', nameId: 'Selandia Baru', flag: 'üá≥üáø' },
    { code: 'NI', code3: 'NIC', nameEn: 'Nicaragua', nameId: 'Nikaragua', flag: 'üá≥üáÆ' },
    { code: 'NE', code3: 'NER', nameEn: 'Niger', nameId: 'Niger', flag: 'üá≥üá™' },
    { code: 'NG', code3: 'NGA', nameEn: 'Nigeria', nameId: 'Nigeria', flag: 'üá≥üá¨' },
    { code: 'KP', code3: 'PRK', nameEn: 'North Korea', nameId: 'Korea Utara', flag: 'üá∞üáµ' },
    { code: 'MK', code3: 'MKD', nameEn: 'North Macedonia', nameId: 'Makedonia Utara', flag: 'üá≤üá∞' },
    { code: 'NO', code3: 'NOR', nameEn: 'Norway', nameId: 'Norwegia', flag: 'üá≥üá¥' },

    { code: 'OM', code3: 'OMN', nameEn: 'Oman', nameId: 'Oman', flag: 'üá¥üá≤' },

    { code: 'PK', code3: 'PAK', nameEn: 'Pakistan', nameId: 'Pakistan', flag: 'üáµüá∞' },
    { code: 'PW', code3: 'PLW', nameEn: 'Palau', nameId: 'Palau', flag: 'üáµüáº' },
    { code: 'PS', code3: 'PSE', nameEn: 'Palestine', nameId: 'Palestina', flag: 'üáµüá∏' },
    { code: 'PA', code3: 'PAN', nameEn: 'Panama', nameId: 'Panama', flag: 'üáµüá¶' },
    { code: 'PG', code3: 'PNG', nameEn: 'Papua New Guinea', nameId: 'Papua Nugini', flag: 'üáµüá¨' },
    { code: 'PY', code3: 'PRY', nameEn: 'Paraguay', nameId: 'Paraguay', flag: 'üáµüáæ' },
    { code: 'PE', code3: 'PER', nameEn: 'Peru', nameId: 'Peru', flag: 'üáµüá™' },
    { code: 'PH', code3: 'PHL', nameEn: 'Philippines', nameId: 'Filipina', flag: 'üáµüá≠' },
    { code: 'PL', code3: 'POL', nameEn: 'Poland', nameId: 'Polandia', flag: 'üáµüá±' },
    { code: 'PT', code3: 'PRT', nameEn: 'Portugal', nameId: 'Portugal', flag: 'üáµüáπ' },

    { code: 'QA', code3: 'QAT', nameEn: 'Qatar', nameId: 'Qatar', flag: 'üá∂üá¶' },

    { code: 'RO', code3: 'ROU', nameEn: 'Romania', nameId: 'Rumania', flag: 'üá∑üá¥' },
    { code: 'RU', code3: 'RUS', nameEn: 'Russia', nameId: 'Rusia', flag: 'üá∑üá∫' },
    { code: 'RW', code3: 'RWA', nameEn: 'Rwanda', nameId: 'Rwanda', flag: 'üá∑üáº' },

    { code: 'KN', code3: 'KNA', nameEn: 'Saint Kitts and Nevis', nameId: 'Saint Kitts dan Nevis', flag: 'üá∞üá≥' },
    { code: 'LC', code3: 'LCA', nameEn: 'Saint Lucia', nameId: 'Saint Lucia', flag: 'üá±üá®' },
    { code: 'VC', code3: 'VCT', nameEn: 'Saint Vincent and the Grenadines', nameId: 'Saint Vincent dan Grenadines', flag: 'üáªüá®' },
    { code: 'WS', code3: 'WSM', nameEn: 'Samoa', nameId: 'Samoa', flag: 'üáºüá∏' },
    { code: 'SM', code3: 'SMR', nameEn: 'San Marino', nameId: 'San Marino', flag: 'üá∏üá≤' },
    { code: 'ST', code3: 'STP', nameEn: 'Sao Tome and Principe', nameId: 'Sao Tome dan Principe', flag: 'üá∏üáπ' },
    { code: 'SA', code3: 'SAU', nameEn: 'Saudi Arabia', nameId: 'Arab Saudi', flag: 'üá∏üá¶' },
    { code: 'SN', code3: 'SEN', nameEn: 'Senegal', nameId: 'Senegal', flag: 'üá∏üá≥' },
    { code: 'RS', code3: 'SRB', nameEn: 'Serbia', nameId: 'Serbia', flag: 'üá∑üá∏' },
    { code: 'SC', code3: 'SYC', nameEn: 'Seychelles', nameId: 'Seychelles', flag: 'üá∏üá®' },
    { code: 'SL', code3: 'SLE', nameEn: 'Sierra Leone', nameId: 'Sierra Leone', flag: 'üá∏üá±' },
    { code: 'SG', code3: 'SGP', nameEn: 'Singapore', nameId: 'Singapura', flag: 'üá∏üá¨' },
    { code: 'SK', code3: 'SVK', nameEn: 'Slovakia', nameId: 'Slovakia', flag: 'üá∏üá∞' },
    { code: 'SI', code3: 'SVN', nameEn: 'Slovenia', nameId: 'Slovenia', flag: 'üá∏üáÆ' },
    { code: 'SB', code3: 'SLB', nameEn: 'Solomon Islands', nameId: 'Kepulauan Solomon', flag: 'üá∏üáß' },
    { code: 'SO', code3: 'SOM', nameEn: 'Somalia', nameId: 'Somalia', flag: 'üá∏üá¥' },
    { code: 'ZA', code3: 'ZAF', nameEn: 'South Africa', nameId: 'Afrika Selatan', flag: 'üáøüá¶' },
    { code: 'KR', code3: 'KOR', nameEn: 'South Korea', nameId: 'Korea Selatan', flag: 'üá∞üá∑' },
    { code: 'SS', code3: 'SSD', nameEn: 'South Sudan', nameId: 'Sudan Selatan', flag: 'üá∏üá∏' },
    { code: 'ES', code3: 'ESP', nameEn: 'Spain', nameId: 'Spanyol', flag: 'üá™üá∏' },
    { code: 'LK', code3: 'LKA', nameEn: 'Sri Lanka', nameId: 'Sri Lanka', flag: 'üá±üá∞' },
    { code: 'SD', code3: 'SDN', nameEn: 'Sudan', nameId: 'Sudan', flag: 'üá∏üá©' },
    { code: 'SR', code3: 'SUR', nameEn: 'Suriname', nameId: 'Suriname', flag: 'üá∏üá∑' },
    { code: 'SE', code3: 'SWE', nameEn: 'Sweden', nameId: 'Swedia', flag: 'üá∏üá™' },
    { code: 'CH', code3: 'CHE', nameEn: 'Switzerland', nameId: 'Swiss', flag: 'üá®üá≠' },
    { code: 'SY', code3: 'SYR', nameEn: 'Syria', nameId: 'Suriah', flag: 'üá∏üáæ' },

    { code: 'TW', code3: 'TWN', nameEn: 'Taiwan', nameId: 'Taiwan', flag: 'üáπüáº' },
    { code: 'TJ', code3: 'TJK', nameEn: 'Tajikistan', nameId: 'Tajikistan', flag: 'üáπüáØ' },
    { code: 'TZ', code3: 'TZA', nameEn: 'Tanzania', nameId: 'Tanzania', flag: 'üáπüáø' },
    { code: 'TH', code3: 'THA', nameEn: 'Thailand', nameId: 'Thailand', flag: 'üáπüá≠' },
    { code: 'TL', code3: 'TLS', nameEn: 'Timor-Leste', nameId: 'Timor Leste', flag: 'üáπüá±' },
    { code: 'TG', code3: 'TGO', nameEn: 'Togo', nameId: 'Togo', flag: 'üáπüá¨' },
    { code: 'TO', code3: 'TON', nameEn: 'Tonga', nameId: 'Tonga', flag: 'üáπüá¥' },
    { code: 'TT', code3: 'TTO', nameEn: 'Trinidad and Tobago', nameId: 'Trinidad dan Tobago', flag: 'üáπüáπ' },
    { code: 'TN', code3: 'TUN', nameEn: 'Tunisia', nameId: 'Tunisia', flag: 'üáπüá≥' },
    { code: 'TR', code3: 'TUR', nameEn: 'Turkey', nameId: 'Turki', flag: 'üáπüá∑' },
    { code: 'TM', code3: 'TKM', nameEn: 'Turkmenistan', nameId: 'Turkmenistan', flag: 'üáπüá≤' },
    { code: 'TV', code3: 'TUV', nameEn: 'Tuvalu', nameId: 'Tuvalu', flag: 'üáπüáª' },

    { code: 'UG', code3: 'UGA', nameEn: 'Uganda', nameId: 'Uganda', flag: 'üá∫üá¨' },
    { code: 'UA', code3: 'UKR', nameEn: 'Ukraine', nameId: 'Ukraina', flag: 'üá∫üá¶' },
    { code: 'AE', code3: 'ARE', nameEn: 'United Arab Emirates', nameId: 'Uni Emirat Arab', flag: 'üá¶üá™' },
    { code: 'GB', code3: 'GBR', nameEn: 'United Kingdom', nameId: 'Inggris Raya', flag: 'üá¨üáß' },
    { code: 'US', code3: 'USA', nameEn: 'United States', nameId: 'Amerika Serikat', flag: 'üá∫üá∏' },
    { code: 'UY', code3: 'URY', nameEn: 'Uruguay', nameId: 'Uruguay', flag: 'üá∫üáæ' },
    { code: 'UZ', code3: 'UZB', nameEn: 'Uzbekistan', nameId: 'Uzbekistan', flag: 'üá∫üáø' },

    { code: 'VU', code3: 'VUT', nameEn: 'Vanuatu', nameId: 'Vanuatu', flag: 'üáªüá∫' },
    { code: 'VA', code3: 'VAT', nameEn: 'Vatican City', nameId: 'Vatikan', flag: 'üáªüá¶' },
    { code: 'VE', code3: 'VEN', nameEn: 'Venezuela', nameId: 'Venezuela', flag: 'üáªüá™' },
    { code: 'VN', code3: 'VNM', nameEn: 'Vietnam', nameId: 'Vietnam', flag: 'üáªüá≥' },

    { code: 'YE', code3: 'YEM', nameEn: 'Yemen', nameId: 'Yaman', flag: 'üáæüá™' },

    { code: 'ZM', code3: 'ZMB', nameEn: 'Zambia', nameId: 'Zambia', flag: 'üáøüá≤' },
    { code: 'ZW', code3: 'ZWE', nameEn: 'Zimbabwe', nameId: 'Zimbabwe', flag: 'üáøüáº' },
  ];

  let rowCount = 0;

  function addQueryRow() {
    rowCount++;
    const template = document.getElementById('queryRowTemplate');
    const clone = template.content.cloneNode(true);
    const rowsContainer = document.getElementById('rowsContainer');

    const queryRow = clone.querySelector('.query-row');
    queryRow.querySelector('.query-row-number').textContent = rowCount;

    // Associate labels with inputs for accessibility
    const nameLabel = queryRow.querySelector('.form-label');
    const nameInput = queryRow.querySelector('.query-name');
    const nameId = `query-name-${rowCount}`;
    nameInput.id = nameId;
    nameLabel.setAttribute('for', nameId);

    const dobLabel = queryRow.querySelectorAll('.form-label')[1];
    const dobInput = queryRow.querySelector('.query-dob');
    const dobId = `query-dob-${rowCount}`;
    dobInput.id = dobId;
    dobLabel.setAttribute('for', dobId);

    const citizenshipLabel = queryRow.querySelectorAll('.form-label')[2];
    const citizenshipInput = queryRow.querySelector('.query-citizenship');
    const citizenshipId = `query-citizenship-${rowCount}`;
    citizenshipInput.id = citizenshipId;
    citizenshipLabel.setAttribute('for', citizenshipId);

    const selectWrapper = queryRow.querySelector('.searchable-select-wrapper');
    const selectInput = selectWrapper.querySelector('.searchable-select-input');
    const dropdown = selectWrapper.querySelector('.searchable-select-dropdown');
    const clearBtn = selectWrapper.querySelector('.select-clear-btn');

    // Generate dropdown options with bilingual support
    renderCountryOptions(dropdown, COUNTRIES);

    selectInput.addEventListener('focus', function() {
      dropdown.classList.add('show');
    });

    selectInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase().trim();
      const filtered = COUNTRIES.filter(country => 
        country.nameId.toLowerCase().includes(searchTerm) ||
        country.nameEn.toLowerCase().includes(searchTerm) ||
        country.code.toLowerCase().includes(searchTerm) ||
        country.code3.toLowerCase().includes(searchTerm)
      );
      renderCountryOptions(dropdown, filtered);
      dropdown.classList.add('show');
      
      // Show/hide clear button
      clearBtn.classList.toggle('show', e.target.value.length > 0);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!selectWrapper.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    rowsContainer.appendChild(clone);
    updateRemoveButtons();
  }

  function renderCountryOptions(dropdown, countries) {
    if (countries.length === 0) {
      dropdown.innerHTML = '<div class="searchable-select-empty">Negara tidak ditemukan</div>';
      return;
    }

    dropdown.innerHTML = countries.map(country => `
      <div class="searchable-select-option" 
           data-code="${country.code}" 
           data-name-id="${country.nameId}"
           data-name-en="${country.nameEn}"
           data-code3="${country.code3}">
        <span class="country-flag">${country.flag}</span>
        <div class="country-info">
          <span class="country-name">${country.nameId}</span>
          <span class="country-code">${country.code} / ${country.code3}</span>
        </div>
      </div>
    `).join('');

    // Add click handlers to options
    dropdown.querySelectorAll('.searchable-select-option').forEach(option => {
      option.addEventListener('click', function() {
        const wrapper = this.closest('.searchable-select-wrapper');
        const input = wrapper.querySelector('.searchable-select-input');
        const clearBtn = wrapper.querySelector('.select-clear-btn');
        const dropdownEl = wrapper.querySelector('.searchable-select-dropdown');
        
        const nameId = this.dataset.nameId;
        const code = this.dataset.code;
        
        input.value = nameId;
        input.dataset.selectedCode = code;
        dropdownEl.classList.remove('show');
        clearBtn.classList.add('show');
      });
    });
  }

  function clearSelection(btn) {
    const wrapper = btn.closest('.searchable-select-wrapper');
    const input = wrapper.querySelector('.searchable-select-input');
    input.value = '';
    delete input.dataset.selectedCode;
    btn.classList.remove('show');
    input.focus();
  }

  function removeQueryRow(btn) {
    const row = btn.closest('.query-row');
    row.remove();
    updateRemoveButtons();
    updateRowNumbers();
  }

  function updateRemoveButtons() {
    const rows = document.querySelectorAll('.query-row');
    const removeButtons = document.querySelectorAll('.btn-remove');
    removeButtons.forEach(btn => {
      btn.style.display = rows.length > 1 ? 'block' : 'none';
    });
  }

  function updateRowNumbers() {
    const rows = document.querySelectorAll('.query-row');
    rows.forEach((row, index) => {
      row.querySelector('.query-row-number').textContent = index + 1;
    });
    rowCount = rows.length;
  }

  document.addEventListener('DOMContentLoaded', function() {
    addQueryRow();
  });
</script>

<script>
  // Submit handler updated for loading state and new displayResults
  document.getElementById('bulkSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const rows = document.querySelectorAll('.query-row');
    const queries = [];

    rows.forEach(row => {
      const name = row.querySelector('.query-name').value.trim();
      const dob = row.querySelector('.query-dob').value;
      const citizenshipInput = row.querySelector('.query-citizenship');
      const citizenship = citizenshipInput.dataset.selectedCode || '';

      if (!name) return;

      const query = { name };
      if (dob) query.date_of_birth = dob;
      if (citizenship) query.citizenship = citizenship;

      queries.push(query);
    });

    if (queries.length === 0) {
      alert('Harap masukkan minimal satu nama nasabah!');
      return;
    }

    const submitBtn = document.getElementById('submitBtn');
    const loadingState = document.getElementById('loadingState');
    submitBtn.disabled = true;
    loadingState.classList.add('show');

    try {
      const response = await fetch('/api/screening/quick-search-bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ queries })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Terjadi kesalahan saat screening');
      }

      displayResults(data);

    } catch (error) {
      console.error('[v0] Error submitting search:', error);
      alert('Gagal melakukan screening: ' + error.message);
    } finally {
      submitBtn.disabled = false;
      loadingState.classList.remove('show');
    }
  });

  let allResults = [];
  let selectedCardIndex = 0;

  function displayResults(data) {
    const resultsContainer = document.getElementById('resultsContainer');
    const nameCardsContainer = document.getElementById('nameCardsContainer');
    const resultsTableContainer = document.getElementById('resultsTableContainer');
    const resultsInfo = document.getElementById('resultsInfo');

    // Clear previous results
    nameCardsContainer.innerHTML = '';
    resultsTableContainer.innerHTML = '';
    resultsContainer.style.display = 'block';

    if (!data || !data.results) {
      resultsInfo.innerHTML = 'Tidak ada hasil yang diterima.';
      return;
    }

    const { results } = data;
    allResults = results;
    
    let totalMatches = 0;
    results.forEach(r => totalMatches += (r.match_count || 0));
    resultsInfo.innerHTML = `Diproses <strong>${results.length}</strong> nasabah, ditemukan <strong>${totalMatches}</strong> matches.`;

    // Generate horizontal cards for each query
    results.forEach((result, index) => {
      const queryName = result.query_data?.name || 'Unknown';
      const matchCount = result.match_count || 0;

      const card = document.createElement('div');
      card.className = `name-card ${index === 0 ? 'active' : ''}`;
      card.onclick = () => selectCard(index);
      card.innerHTML = `
        <div class="name-card-name">${queryName}</div>
        <div class="name-card-matches">${matchCount} matches</div>
      `;
      nameCardsContainer.appendChild(card);
    });

    // Display table for first card
    displayTableForCard(0);
  }

  function selectCard(index) {
    selectedCardIndex = index;
    
    // Update active state
    const cards = document.querySelectorAll('.name-card');
    cards.forEach((card, i) => {
      card.classList.toggle('active', i === index);
    });

    // Display table for selected card
    displayTableForCard(index);
  }

  function getScoreClass(score) {
    if (score >= 80) return 'score-high';
    if (score >= 60) return 'score-medium';
    return 'score-low';
  }

  function displayTableForCard(index) {
    const resultsTableContainer = document.getElementById('resultsTableContainer');
    const result = allResults[index];

    if (!result) return;

    const matchCount = result.match_count || 0;

    if (matchCount === 0) {
      resultsTableContainer.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: var(--text-light);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚úì</div>
          <div style="font-size: 1.1rem; font-weight: 500; color: var(--text-primary);">Aman (No Match)</div>
        </div>
      `;
      return;
    }

    let html = `
      <div class="results-table-container">
        <table class="results-table">
          <thead>
            <tr>
              <th style="width: 50px;">#</th>
              <th>Nama (Sanction)</th>
              <th style="width: 130px;">Skor Nama</th>
              <th style="width: 150px;">Skor Akhir</th>
              <th style="width: 100px;"></th>
            </tr>
          </thead>
          <tbody>`;

    result.matches.forEach((match, idx) => {
      const nameScore = (match.name_score || 0).toFixed(1);
      const finalScore = (match.final_score || 0).toFixed(1);
      const nameScoreClass = getScoreClass(match.name_score || 0);
      const finalScoreClass = getScoreClass(match.final_score || 0);
      
      const hasGeoInsights = match.geographic_insights && match.geographic_insights.length > 0;
      
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>
            <span class="entity-name">${match.sanction_name}</span>
            <div class="entity-meta">ID: ${match.sanction_id} | ${match.sanction_source || '-'}</div>
          </td>
          <td>
            <span class="score-badge ${nameScoreClass}">${nameScore}%</span>
          </td>
          <td class="score-cell">
            <span class="score-badge ${finalScoreClass}">${finalScore}%</span>
            <button class="score-breakdown-btn" onclick="toggleScoreBreakdown(event, 'score-${index}-${idx}')">
              <span class="arrow-icon">‚ñº</span> Rincian
            </button>
            <div class="score-breakdown-section" id="score-${index}-${idx}">
              <div class="score-breakdown-content">
                <div class="score-breakdown-item">
                  <span class="score-breakdown-label">Skor Nama</span>
                  <span class="score-breakdown-value">${nameScore}%</span>
                </div>
                ${match.dob_score !== null && match.dob_score !== undefined ? `
                <div class="score-breakdown-item">
                  <span class="score-breakdown-label">Skor Tanggal Lahir</span>
                  <span class="score-breakdown-value">${(match.dob_score || 0).toFixed(1)}%</span>
                </div>` : ''}
                ${match.citizenship_score !== null && match.citizenship_score !== undefined ? `
                <div class="score-breakdown-item">
                  <span class="score-breakdown-label">Skor Kewarganegaraan</span>
                  <span class="score-breakdown-value">${(match.citizenship_score || 0).toFixed(1)}%</span>
                </div>` : ''}
                <div class="score-breakdown-item" style="border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.25rem;">
                  <span class="score-breakdown-label" style="font-weight: 600;">Skor Akhir</span>
                  <span class="score-breakdown-value" style="font-size: 1.05em; color: var(--primary-accent);">${finalScore}%</span>
                </div>
              </div>
            </div>
          </td>
          <td style="text-align: right;">
            ${hasGeoInsights ? 
              `<button class="geo-collapsible-btn" onclick="toggleGeoProfile(this, '${result.request_id}-${idx}')"><span class="arrow-icon">‚ñº</span> Details</button>` 
              : '<span style="font-size: 0.8rem; color: var(--text-light);">‚Äî</span>'}
          </td>
        </tr>`;
        
      if (hasGeoInsights) {
        html += `
        <tr style="display: none;" class="geo-profile-row-${result.request_id}-${idx}">
          <td colspan="5" style="padding: 0; border: none;">
            <div class="geo-profiling-section" id="geo-profile-${result.request_id}-${idx}">
              <div class="geo-profiling-content">`;
              
        const queryData = result.query_data || {};
        const userCitizenship = queryData.citizenship || '?';

        if (match.sanction_citizenship) {
          html += `
                <div class="geo-item">
                  <div class="geo-item-icon">üìç</div>
                  <div class="geo-item-content">
                    <div class="geo-item-label">Registrasi Kewarganegaraan</div>
                    <div class="geo-item-value">${userCitizenship} <span style="color: var(--text-light); margin: 0 0.5rem;">‚Üí</span> ${match.sanction_citizenship}</div>
                  </div>
                </div>`;
        }
        
        html += `
                <div class="geo-insights-box">
                  <strong>‚ö†Ô∏è Geographic Insights</strong>
                  <ul class="geo-insights-list">
                    ${match.geographic_insights.map(insight => {
                      const cleanInsight = insight.replace(/^‚ö†Ô∏è\s*/, '');
                      return `<li>${cleanInsight}</li>`;
                    }).join('')}
                  </ul>
                </div>
                <div class="geo-item">
                  <div class="geo-item-icon">üèõÔ∏è</div>
                  <div class="geo-item-content">
                    <div class="geo-item-label">Scheme</div>
                    <div class="geo-item-value">${match.scheme || 'N/A'}</div>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>`;
      }
    });
    
    html += `
          </tbody>
        </table>
      </div>`;
    
    resultsTableContainer.innerHTML = html;
  }

  function toggleScoreBreakdown(event, breakdownId) {
    event.preventDefault();
    event.stopPropagation();
    
    const button = event.currentTarget;
    const breakdown = document.getElementById(breakdownId);
    
    if (!breakdown) return;
    
    const isExpanded = button.classList.contains('expanded');
    
    if (isExpanded) {
      button.classList.remove('expanded');
      breakdown.classList.remove('expanded');
    } else {
      button.classList.add('expanded');
      breakdown.classList.add('expanded');
    }
  }

  function toggleGeoProfile(button, matchId) {
    event.preventDefault();
    event.stopPropagation();
    
    const geoRow = document.querySelector(`.geo-profile-row-${matchId}`);
    const geoProfile = document.getElementById(`geo-profile-${matchId}`);
    
    if (!geoRow || !geoProfile) {
      console.log('[v0] Geo profile elements not found:', matchId);
      return;
    }
    
    const isExpanded = button.classList.contains('expanded');
    
    if (isExpanded) {
      button.classList.remove('expanded');
      geoProfile.classList.remove('expanded');
      setTimeout(() => {
        geoRow.style.display = 'none';
      }, 300);
    } else {
      geoRow.style.display = 'table-row';
      setTimeout(() => {
        geoProfile.classList.add('expanded');
        button.classList.add('expanded');
      }, 10);
    }
  }
</script>
{% endblock content %}

