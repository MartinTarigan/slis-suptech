{% extends "base.html" %}

{% block head %}
<style>
  /* Bulk Screening Wizard - Simplified Single Step */
  .wizard-container {
    max-width: 800px;
    margin: 0 auto;
  }

  .wizard-header {
    margin-bottom: 2rem;
    text-align: center;
  }

  .wizard-title h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .wizard-title p {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  /* Simplified to show only sanction selection first */
  .step-sanction-selection {
    display: block;
  }

  .step-screening-form {
    display: none;
  }

  .step-sanction-selection.hidden,
  .step-screening-form.hidden {
    display: none;
  }

  .step-sanction-selection.active {
    display: block;
  }

  .step-screening-form.active {
    display: block;
  }

  /* Sanction Mode Selection - Large Buttons */
  .sanction-mode-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .mode-card {
    background-color: var(--surface);
    border: 3px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .mode-card:hover {
    border-color: var(--primary-accent);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
  }

  .mode-card.selected {
    border-color: var(--primary-accent);
    background-color: rgba(14, 165, 233, 0.05);
  }

  .mode-card-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
  }

  .mode-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .mode-card-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .mode-card-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background-color: var(--success);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Form Card */
  .form-card {
    background-color: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    margin-bottom: 2rem;
  }

  .form-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .form-section-icon {
    width: 32px;
    height: 32px;
    background-color: rgba(14, 165, 233, 0.1);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }

  .section-divider {
    height: 1px;
    background: linear-gradient(to right, transparent, var(--border), transparent);
    margin: 2.5rem 0;
  }

  .info-box {
    background-color: rgba(14, 165, 233, 0.05);
    border-left: 4px solid var(--primary-accent);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
    font-size: 0.9rem;
    line-height: 1.6;
  }

  /* File Upload Area */
  .file-upload-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    background-color: rgba(14, 165, 233, 0.02);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .file-upload-area:hover {
    border-color: var(--primary-accent);
    background-color: rgba(14, 165, 233, 0.06);
  }

  .file-upload-area.dragover {
    border-color: var(--primary-accent);
    background-color: rgba(14, 165, 233, 0.1);
    box-shadow: inset 0 0 12px rgba(14, 165, 233, 0.1);
  }

  .file-upload-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
  }

  .file-upload-area h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .file-upload-area p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0;
  }

  .file-upload-area input[type="file"] {
    display: none;
  }

  /* Sanction DB Info Display */
  .sanction-db-summary {
    background-color: rgba(16, 185, 129, 0.05);
    border: 1px solid var(--success);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .db-summary-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .db-summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .db-summary-item {
    text-align: center;
  }

  .db-summary-label {
    font-size: 0.75rem;
    color: var(--text-light);
    display: block;
    margin-bottom: 0.25rem;
  }

  .db-summary-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Upload sanction section for new upload mode */
  .sanction-upload-form {
    margin-bottom: 1.5rem;
  }

  /* Threshold Configuration */
  .threshold-group {
    background-color: var(--background);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
  }

  .threshold-input-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .threshold-value-display {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--primary-accent);
    text-align: center;
    padding: 0.75rem 1.25rem;
    background-color: var(--surface);
    border-radius: 8px;
    min-width: 100px;
    border: 2px solid rgba(14, 165, 233, 0.2);
  }

  .form-control[type="range"] {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  .form-control[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--primary-accent);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    border: 3px solid white;
  }

  .form-control[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--primary-accent);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
    border: 3px solid white;
  }

  .threshold-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
  }

  .threshold-info-item {
    padding: 0.75rem;
    background-color: var(--surface);
    border-radius: 6px;
    border-left: 3px solid var(--primary-accent);
  }

  .threshold-info-label {
    font-size: 0.8rem;
    color: var(--text-light);
    font-weight: 500;
  }

  .threshold-info-value {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 0.25rem;
  }

  .form-text {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-light);
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    margin-top: 2rem;
  }

  .form-actions .btn {
    flex: 1;
    padding: 0.75rem 1.5rem;
  }

  .btn-submit {
    background-color: var(--primary-accent);
    color: white;
    font-weight: 600;
  }

  .btn-submit:hover:not(:disabled) {
    background-color: #0284c7;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  }

  .btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-back {
    background-color: transparent;
    border: 1px solid var(--border);
    color: var(--text-primary);
  }

  .btn-back:hover {
    background-color: var(--background);
  }

  @media (max-width: 768px) {
    .sanction-mode-cards {
      grid-template-columns: 1fr;
    }

    .form-card {
      padding: 1.5rem;
    }

    .file-upload-area {
      padding: 2rem 1.5rem;
    }

    .threshold-input-row {
      grid-template-columns: 1fr;
    }

    .threshold-info,
    .db-summary-grid {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }

    .form-actions .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
  <div class="wizard-header">
    <div class="wizard-title">
      <h1>Bulk Screening</h1>
      <p>Screening transaksi batch terhadap sanction list</p>
    </div>
  </div>

  <div class="step-sanction-selection active" id="stepSanctionSelection">
    <div class="form-card">
      <div class="form-section-title">
        <div class="form-section-icon">üõ°Ô∏è</div>
        Pilih Sumber Sanction List
      </div>

      <div class="sanction-mode-cards">
        <div class="mode-card" onclick="selectSanctionMode('db')">
          <span class="mode-card-badge">Recommended</span>
          <span class="mode-card-icon">‚úì</span>
          <div class="mode-card-title">Gunakan Database</div>
          <div class="mode-card-desc">
            Gunakan sanction list terbaru yang sudah tersimpan di database
          </div>
        </div>

        <div class="mode-card" onclick="selectSanctionMode('upload')">
          <span class="mode-card-icon">‚¨Ü</span>
          <div class="mode-card-title">Upload Baru</div>
          <div class="mode-card-desc">
            Upload file sanction list baru untuk screening ini
          </div>
        </div>
      </div>

      <div class="form-actions">
        <a href="{{ url_for('web.index') }}" class="btn btn-back">‚Üê Kembali</a>
      </div>
    </div>
  </div>

  <div class="step-screening-form" id="stepScreeningForm">
    <form method="post" action="{{ url_for('web.bulk_screening_submit') }}" enctype="multipart/form-data" id="screeningForm">
      <input type="hidden" name="sanction_mode" id="sanctionModeInput" value="">
      
      <div class="form-card">
        <!-- Sanction List Summary (for DB mode) or Upload (for upload mode) -->
        <div class="form-section-title">
          <div class="form-section-icon">üõ°Ô∏è</div>
          Sanction List
        </div>

        <!-- DB Mode Summary -->
        <div class="sanction-db-summary" id="dbSummary" style="display: none;">
          <div class="db-summary-title">
            ‚úì Menggunakan Database Sanction List
          </div>
          <div class="db-summary-grid">
            <div class="db-summary-item">
              <span class="db-summary-label">Version</span>
              <span class="db-summary-value">Dec 2025</span>
            </div>
            <div class="db-summary-item">
              <span class="db-summary-label">Last Updated</span>
              <span class="db-summary-value">2 jam lalu</span>
            </div>
            <div class="db-summary-item">
              <span class="db-summary-label">Total Entities</span>
              <span class="db-summary-value">12,543</span>
            </div>
          </div>
        </div>

        <!-- Upload Mode Form -->
        <div class="sanction-upload-form" id="uploadSanctionForm" style="display: none;">
          <label class="form-label">Upload Sanction List File</label>
          <input type="file" name="sanction_file" id="sanctionFileInput" accept=".txt,.csv" class="form-control">
          <div class="form-text">Format: .txt atau .csv dengan header yang sesuai</div>
        </div>

        <div class="section-divider"></div>

        <!-- Upload Transaksi -->
        <div class="form-section-title">
          <div class="form-section-icon">üìÅ</div>
          Upload File Transaksi
        </div>

        <div class="info-box">
          <strong>Format File yang Diterima:</strong>
          <ul>
            <li>Format: Text (.txt) atau CSV (.csv)</li>
            <li>Header: transaction_id, sender_name, sender_dob, sender_citizenship, receiver_name, receiver_dob, receiver_citizenship</li>
            <li>Maksimal 1 juta baris per file</li>
          </ul>
        </div>

        <div class="file-upload-area" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
          <span class="file-upload-icon">üì§</span>
          <h3>Drag & Drop atau Klik untuk Upload</h3>
          <p>Pilih file transaksi (.txt atau .csv)</p>
          <input type="file" id="fileInput" name="transaction_file" accept=".txt,.csv" onchange="handleFileSelect(event)" required>
        </div>

        <div class="section-divider"></div>

        <!-- Threshold Configuration -->
        <div class="form-section-title">
          <div class="form-section-icon">üéØ</div>
          Threshold Configuration
        </div>

        <div class="threshold-group">
          <label class="form-label">Final Score Threshold</label>
          <div class="threshold-input-row">
            <input type="range" name="threshold_score" class="form-control" value="60" min="0" max="100" 
                   oninput="updateThresholdDisplay(this, 'finalDisplay')">
            <div class="threshold-value-display" id="finalDisplay">60%</div>
          </div>

          <div class="form-text">
            Skor minimum gabungan (nama + DOB + kewarganegaraan) untuk dianggap potential match.
          </div>

          <div class="threshold-info">
            <div class="threshold-info-item">
              <div class="threshold-info-label">Luas (Banyak hasil)</div>
              <div class="threshold-info-value">40-50%</div>
            </div>
            <div class="threshold-info-item">
              <div class="threshold-info-label">Rekomendasi</div>
              <div class="threshold-info-value">50-65%</div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-back" onclick="backToSelection()">‚Üê Ubah Sanction List</button>
          <button type="submit" class="btn btn-submit" id="submitBtn" disabled>Mulai Screening ‚Üí</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  let selectedMode = '';

  function selectSanctionMode(mode) {
    selectedMode = mode;
    document.getElementById('sanctionModeInput').value = mode;
    
    // Hide selection, show form
    document.getElementById('stepSanctionSelection').classList.remove('active');
    document.getElementById('stepSanctionSelection').classList.add('hidden');
    document.getElementById('stepScreeningForm').classList.add('active');
    document.getElementById('stepScreeningForm').classList.remove('hidden');
    
    // Show appropriate section
    if (mode === 'db') {
      document.getElementById('dbSummary').style.display = 'block';
      document.getElementById('uploadSanctionForm').style.display = 'none';
      document.getElementById('sanctionFileInput').removeAttribute('required');
    } else {
      document.getElementById('dbSummary').style.display = 'none';
      document.getElementById('uploadSanctionForm').style.display = 'block';
      document.getElementById('sanctionFileInput').setAttribute('required', 'required');
    }
  }

  function backToSelection() {
    document.getElementById('stepScreeningForm').classList.remove('active');
    document.getElementById('stepScreeningForm').classList.add('hidden');
    document.getElementById('stepSanctionSelection').classList.add('active');
    document.getElementById('stepSanctionSelection').classList.remove('hidden');
    
    // Reset form
    document.getElementById('screeningForm').reset();
    document.getElementById('submitBtn').disabled = true;
    
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.innerHTML = `<span class="file-upload-icon">üì§</span><h3>Drag & Drop atau Klik untuk Upload</h3><p>Pilih file transaksi (.txt atau .csv)</p><input type="file" id="fileInput" name="transaction_file" accept=".txt,.csv" onchange="handleFileSelect(event)" required>`;
  }

  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const submitBtn = document.getElementById('submitBtn');

  uploadArea.addEventListener('click', () => fileInput.click());

  function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  }

  function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
  }

  function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const newFileInput = document.getElementById('fileInput');
      newFileInput.files = files;
      handleFileSelect();
    }
  }

  function handleFileSelect() {
    const file = document.getElementById('fileInput').files[0];
    if (file) {
      submitBtn.disabled = false;
      uploadArea.innerHTML = `<span class="file-upload-icon">‚úì</span><h3>${file.name}</h3><p style="color: var(--success); margin-bottom: 0;">File dipilih</p>`;
    }
  }

  function updateThresholdDisplay(input, displayId) {
    document.getElementById(displayId).textContent = input.value + '%';
  }
</script>
{% endblock %}
